// 将 COCO 数据放入变量中
const cocoData = {
    "info": {
        "description": 
        "coco from ISAT", 
        "version": null, 
        "year": null, 
        "contributor": null, 
        "date_created": null}, 
        "licenses": [{
            "url": null, 
            "id": 0, 
            "name": null}], 
            "images": [{
                "license": "", 
                "url": "", 
                "file_name": "p71.png", 
                "height": 1691, 
                "width": 1097, 
                "date_captured": "", 
                "id": 0}], 
                "annotations": [{
                    "iscrowd": 0, 
                    "image_id": 0, 
                    "image_name": "p71.png", 
                    "category_id": 1, 
                    "id": 0, 
                    "segmentation": [[349.26, 705.65, 331.26, 709.65, 312.26, 722.65, 304.26, 731.65, 296.26, 746.65, 288.26, 784.65, 281.26, 799.65, 273.26, 805.65, 234.26, 820.65, 219.26, 835.65, 216.26, 841.65, 209.26, 868.65, 206.26, 948.65, 209.26, 959.65, 217.26, 966.65, 218.26, 972.65, 208.26, 1002.65, 207.26, 1033.65, 212.26, 1078.65, 219.26, 1084.65, 227.26, 1104.65, 233.26, 1110.65, 237.26, 1122.65, 247.26, 1135.65, 255.26, 1152.65, 259.26, 1169.65, 266.26, 1171.65, 275.26, 1166.65, 288.26, 1164.65, 304.26, 1179.65, 311.26, 1182.65, 320.26, 1181.65, 326.26, 1183.65, 338.26, 1195.65, 351.26, 1199.65, 357.26, 1204.65, 366.26, 1205.65, 371.26, 1203.65, 375.26, 1191.65, 372.26, 1172.65, 366.26, 1157.65, 363.26, 1111.65, 372.26, 1105.65, 395.26, 1102.65, 408.26, 1091.65, 410.26, 1083.65, 410.26, 1012.65, 410.63, 1003.07, 411.63, 996.07, 410.02, 985.25, 409.46, 977.65, 408.26, 972.65, 408.26, 950.65, 411.2, 940.82, 412.13, 936.95, 411.01, 932.19, 414.48, 897.7, 417.23, 864.03, 428.43, 845.23, 430.26, 837.65, 429.26, 811.65, 437.26, 799.65, 443.49, 789.59, 433.78, 784.77, 423.48, 787.7, 414.26, 790.65, 402.15, 793.63, 403.26, 833.65, 400.26, 842.65, 390.26, 854.65, 376.26, 846.65, 358.26, 828.65, 361.26, 806.65, 368.26, 790.65, 376.26, 758.65, 366.26, 712.65, 358.26, 706.65]], 
                    "area": 75241.55539856217, 
                    "bbox": [205.76532521614504, 705.0564360457987, 238.15434237649444, 501.09350062633814],
                    "description": '为佛举着画布的人'
                }, 
                    {"iscrowd": false, 
                        "image_id": 0, 
                        "image_name": "p71.png", 
                        "category_id": 1, 
                        "id": 1, 
                        "segmentation": [[571.31, 727.55, 569.1, 734.78, 575.53, 745.42, 571.92, 749.64, 559.47, 761.28, 554.04, 771.93, 549.02, 783.17, 552.04, 806.47, 558.66, 823.94, 567.5, 839.2, 570.31, 864.7, 564.49, 871.13, 536.57, 888.4, 520.31, 912.9, 510.87, 929.36, 486.39, 994.17, 450.24, 952.82, 433.18, 940.67, 447.35, 928.53, 453.13, 911.18, 441.27, 887.47, 434.62, 870.98, 425.37, 868.38, 406.57, 886.89, 393.56, 887.75, 379.97, 897.3, 392.69, 928.82, 417.85, 961.78, 451.69, 1026.27, 469.61, 1041.59, 486.53, 1057.16, 498.1, 1054.03, 534.48, 989.21, 538.1, 975.47, 549.42, 1026.32, 547.5, 1072.82, 539.3, 1101.02, 527.98, 1105.36, 474.0, 1092.1, 434.0, 1092.34, 403.88, 1109.69, 392.79, 1139.33, 408.94, 1176.2, 448.22, 1211.63, 507.28, 1244.82, 521.66, 1256.16, 517.91, 1261.07, 508.36, 1269.75, 505.18, 1284.5, 495.64, 1293.17, 494.19, 1310.23, 503.45, 1328.16, 512.41, 1333.95, 526.0, 1326.72, 531.79, 1315.73, 539.01, 1314.86, 556.94, 1326.14, 579.79, 1318.62, 587.88, 1318.04, 601.19, 1332.79, 614.49, 1326.72, 624.9, 1300.69, 617.38, 1280.45, 642.25, 1285.94, 657.29, 1294.33, 665.09, 1280.16, 666.25, 1259.63, 694.88, 1257.89, 701.53, 1264.54, 712.23, 1254.42, 719.75, 1233.89, 720.04, 1216.54, 730.56, 1185.2, 741.4, 1168.93, 776.51, 1125.5, 763.32, 1096.71, 772.92, 1061.94, 770.52, 1046.35, 757.33, 1021.76, 751.93, 1000.17, 756.03, 952.9, 755.03, 941.41, 750.92, 911.93, 740.16, 884.86, 714.83, 868.9, 700.95, 861.27, 685.34, 856.06, 676.66, 848.43, 660.7, 838.36, 654.8, 826.22, 655.15, 806.09, 655.49, 787.35, 651.33, 770.7, 647.16, 760.98, 635.71, 753.0, 626.69, 746.76, 615.24, 743.29, 607.95, 737.39, 602.4, 725.93, 599.28, 720.73, 591.64, 719.69, 579.15, 723.16]], 
                        "area": 132959.38135064894, 
                        "bbox": [379.5070394280275, 719.1933597609427, 397.4618385943494, 615.1938809819626],
                        "description": '佛居中交脚坐于高座上，左手持钵，右手执笔正在布帛上画自画像'
                    }], 
                        "categories": [{
                            "name": "person", 
                            "id": 1, 
                            "supercategory": null}]};

// 初始化画布
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const infoBox = document.getElementById('info-box');


// 加载图像
const img = new Image();
img.src = "p71.png";



// 图像加载完毕后执行
img.onload = () => {
    // 根据图片的宽高比调整画布尺寸
    const aspectRatio = img.width / img.height;
    canvas.width = canvas.clientWidth; // 使用 CSS 控制宽度
    canvas.height = canvas.width / aspectRatio; // 高度按照比例调整

    // 绘制图像
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // 添加鼠标移动事件监听器
    canvas.addEventListener('mousemove', (event) => {
        const mouseX = event.offsetX;
        const mouseY = event.offsetY;

        let activeAnnotation = null;

        // 清除画布并重新绘制背景
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        cocoData.annotations.forEach(annotation => {
            const segmentation = annotation.segmentation[0];
            ctx.beginPath();
            for (let i = 0; i < segmentation.length; i += 2) {
                const x = (segmentation[i] / cocoData.images[0].width) * canvas.width;
                const y = (segmentation[i + 1] / cocoData.images[0].height) * canvas.height;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.closePath();

            // 高亮检测
            if (ctx.isPointInPath(mouseX, mouseY)) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                activeAnnotation = annotation;
            } else {
                ctx.fillStyle = 'rgba(255, 0, 0, 0)';
            }
            ctx.fill();
        });

        // 显示注释信息
        if (activeAnnotation) {
            const infoBoxX = event.pageX + 10;
            const infoBoxY = event.pageY + 10;
            infoBox.style.left = `${infoBoxX}px`;
            infoBox.style.top = `${infoBoxY}px`;
            infoBox.textContent = activeAnnotation.description;
            infoBox.style.display = 'block';
        } else {
            infoBox.style.display = 'none';
        }
    });
};
