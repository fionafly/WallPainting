// 将 COCO 数据放入变量中
const cocoData = {
    "info": {
        "description": "coco from ISAT", 
        "version": null, 
        "year": null, 
        "contributor": null, 
        "date_created": null}, 
        "licenses": [{
            "url": null, 
            "id": 0, 
            "name": null}], 
            "images": [{
                "license": "", 
                "url": "", 
                "file_name": "p66.png", 
                "height": 1697, 
                "width": 1084, 
                "date_captured": "", 
                "id": 0}], 
                "annotations": [{
                    "iscrowd": false, 
                    "image_id": 0, 
                    "image_name": "p66.png", 
                    "category_id": 1, "id": 0, 
                    "segmentation": [[606.27, 976.34, 588.71, 905.64, 580.69, 954.28, 583.2, 974.34, 574.67, 955.28, 565.65, 931.21, 559.63, 968.82, 569.66, 998.41, 582.7, 1018.47, 583.7, 1031.0, 538.07, 1085.66, 543.08, 1104.22, 567.65, 1105.72, 582.2, 1087.67, 607.77, 1082.15, 633.85, 1104.72, 642.37, 1117.76, 640.37, 1075.63, 639.86, 1034.51, 629.33, 1008.44, 613.79, 1020.47, 584.2, 1000.41, 601.25, 975.84, 605.26, 974.34], [687.5, 1199.99, 689.51, 1262.68, 667.95, 1338.9, 654.41, 1381.52, 695.02, 1375.0, 689.51, 1345.42, 723.11, 1273.71, 726.62, 1211.53, 687.0, 1199.49]], 
                    "area": 14328.71633279603, 
                    "bbox": [537.5844030173871, 905.5171516569153, 189.5310237610306, 476.50012645552556],
                    "description": '一只载满货物的牛',
                }, 
                    {"iscrowd": 0, 
                        "image_id": 0, 
                        "image_name": "p66.png", 
                        "category_id": 1, 
                        "id": 1, 
                        "segmentation": [[658.32, 846.67, 639.66, 900.22, 643.27, 940.54, 615.59, 964.61, 598.74, 977.85, 590.32, 1010.34, 611.98, 1020.57, 631.84, 1015.16, 642.07, 1045.24, 638.46, 1091.58, 650.49, 1142.13, 669.75, 1172.21, 645.68, 1183.65, 620.41, 1228.78, 630.64, 1234.8, 651.1, 1203.51, 682.99, 1196.28, 711.87, 1202.3, 727.52, 1214.94, 719.7, 1309.41, 692.02, 1387.64, 716.69, 1384.63, 738.35, 1352.14, 752.19, 1216.14, 866.52, 1208.32, 886.38, 1100.0, 915.27, 1066.91, 913.46, 1041.63, 894.2, 943.55, 867.73, 918.88, 841.25, 902.63, 813.57, 897.81, 788.3, 897.81, 765.43, 918.88, 747.98, 945.35, 740.76, 951.37, 729.32, 944.75, 710.67, 948.36, 719.7, 930.31, 734.74, 922.49, 740.76, 905.04, 767.84, 882.17, 749.78, 884.58, 727.52, 911.05, 704.65, 929.11, 678.18, 935.12, 662.53, 927.3, 649.29, 913.46, 650.49, 894.2, 650.49, 877.36, 655.31, 858.7]], 
                        "area": 80043.2020914416, 
                        "bbox": [589.8352672780416, 846.0292153335629, 325.92911260292, 542.1085212308483],
                        "description": '另一只载满货物的牛',
                    }, 
                        
                        {"iscrowd": false, 
                            "image_id": 0, 
                            "image_name": "p66.png", 
                            "category_id": 2, 
                            "id": 2, 
                            "segmentation": [
                            [631.0, 406.0, 614.0, 439.0, 601.4, 508.92, 610.7, 528.81, 611.42, 543.05, 612.54, 561.08, 610.09, 607.04, 584.34, 580.31, 575.73, 572.79, 564.72, 565.61, 554.25, 563.9, 544.96, 560.52, 537.13, 559.0, 533.39, 559.21, 528.45, 558.45, 519.01, 559.05, 511.83, 559.4, 504.45, 561.21, 499.54, 562.52, 490.0, 564.0, 445.0, 599.0, 441.0, 594.0, 445.0, 528.0, 456.0, 507.0, 459.0, 470.0, 447.0, 405.0, 441.0, 399.0, 423.0, 433.0, 416.0, 470.0, 404.0, 483.0, 410.0, 536.0, 399.0, 594.0, 408.0, 655.0, 418.0, 683.0, 410.0, 765.0, 394.0, 791.0, 359.0, 780.0, 337.0, 788.0, 333.0, 805.0, 342.0, 831.0, 340.0, 851.0, 286.0, 850.0, 268.0, 864.0, 252.0, 895.0, 241.0, 952.0, 235.0, 1026.0, 228.0, 1046.0, 243.0, 1044.0, 270.0, 1004.0, 283.0, 938.0, 309.0, 897.0, 327.0, 892.0, 347.0, 897.0, 349.0, 943.0, 368.0, 940.0, 375.0, 932.0, 384.0, 1025.0, 394.0, 1039.0, 400.0, 1077.0, 433.0, 1187.0, 437.0, 1251.0, 457.0, 1269.0, 468.0, 1299.0, 467.0, 1315.0, 448.0, 1340.0, 452.0, 1357.0, 460.0, 1361.0, 474.0, 1358.0, 500.0, 1333.0, 497.0, 1232.0, 529.0, 1190.0, 565.11, 1197.97, 557.44, 1159.15, 555.69, 1145.35, 545.0, 1146.0, 532.0, 1138.0, 537.0, 1119.0, 540.75, 1119.33, 540.8, 1112.81, 527.0, 1085.0, 527.0, 1063.0, 524.35, 1059.21, 523.87, 1054.0, 542.0, 1034.0, 560.41, 965.73, 562.9, 955.43, 565.0, 937.0, 566.0, 885.0, 580.0, 882.0, 602.71, 887.16, 596.29, 914.99, 597.0, 951.0, 586.0, 958.0, 587.0, 977.0, 614.0, 965.0, 637.0, 938.0, 629.0, 874.0, 616.0, 856.0, 584.0, 844.0, 574.0, 812.0, 587.0, 738.0, 635.0, 676.0, 647.0, 644.0, 636.0, 539.0, 642.0, 500.0, 640.0, 442.0],[592.07, 1329.51, 589.07, 1331.51, 587.07, 1333.51, 574.37, 1339.27, 573.03, 1357.61, 581.91, 1365.69, 584.89, 1365.2, 589.18, 1365.17, 592.99, 1366.47, 597.72, 1359.55, 606.87, 1346.42, 595.07, 1330.51]], 
                            "area": 150819.98567180484, 
                            "bbox": [227.52807082181698, 398.6464466094067, 419.96920779414313, 968.2924675958009],
                            "description": '商主萨薄以白毡缠绕双臂，浇上酥油，燃臂当炬为众商客引路',
                        }, 
                            {"iscrowd": false, 
                                "image_id": 0, 
                                "image_name": "p66.png", 
                                "category_id": 2, 
                                "id": 3, 
                                "segmentation": [[750.69, 608.89, 742.69, 608.89, 718.69, 612.89, 706.69, 619.89, 695.69, 631.89, 683.69, 636.89, 662.69, 657.89, 653.69, 683.89, 653.69, 703.89, 656.69, 725.89, 663.69, 751.89, 672.69, 771.89, 672.69, 782.89, 669.69, 799.89, 669.69, 817.89, 672.69, 833.89, 672.69, 849.89, 669.69, 871.89, 667.69, 876.89, 666.69, 886.89, 664.69, 889.89, 665.69, 896.89, 663.69, 901.89, 664.69, 917.89, 666.69, 923.89, 669.69, 926.89, 677.69, 930.89, 686.69, 931.89, 711.2, 924.51, 749.71, 886.49, 768.29, 880.04, 721.18, 932.6, 716.42, 939.61, 715.17, 948.28, 721.04, 946.92, 727.69, 945.89, 738.69, 945.89, 741.69, 942.89, 745.21, 941.24, 753.04, 933.25, 758.69, 927.89, 765.69, 921.89, 769.69, 911.89, 776.69, 903.89, 786.69, 899.89, 796.69, 892.89, 798.69, 878.89, 804.69, 863.89, 805.69, 852.89, 812.69, 830.89, 812.69, 811.89, 809.69, 801.89, 805.69, 794.89, 798.69, 789.89, 797.69, 783.89, 773.59, 759.32, 784.95, 744.74, 794.48, 723.34, 797.63, 713.58, 804.01, 692.78, 801.21, 672.85, 772.25, 665.15, 748.31, 682.79, 747.17, 690.57, 703.88, 715.65, 697.95, 728.96, 680.26, 694.19, 690.8, 675.78, 702.7, 658.41, 717.69, 639.77, 731.41, 650.52, 742.84, 652.71, 738.42, 636.93, 762.14, 641.21, 779.69, 632.89, 777.69, 624.89, 772.69, 614.89, 760.69, 609.89, 751.69, 609.89]], 
                                "area": 34704.10776827845, 
                                "bbox": [653.192337406453, 608.3927883189299, 160.0, 340.37639722405424],
                                "description": '一龟兹装束的商人',
                            }], 
                                "categories": [{
                                    "name": "cattle", 
                                    "id": 1, 
                                    "supercategory": null}, 
                                    {"name": "person", 
                                        "id": 2, 
                                        "supercategory": null}]};

// 初始化画布
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const infoBox = document.getElementById('info-box');


// 加载图像
const img = new Image();
img.src = "p66.png";



// 图像加载完毕后执行
img.onload = () => {
    // 根据图片的宽高比调整画布尺寸
    const aspectRatio = img.width / img.height;
    canvas.width = canvas.clientWidth; // 使用 CSS 控制宽度
    canvas.height = canvas.width / aspectRatio; // 高度按照比例调整

    // 绘制图像
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // 添加鼠标移动事件监听器
    canvas.addEventListener('mousemove', (event) => {
        const mouseX = event.offsetX;
        const mouseY = event.offsetY;

        let activeAnnotation = null;

        // 清除画布并重新绘制背景
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        cocoData.annotations.forEach(annotation => {
            const segmentation = annotation.segmentation[0];
            ctx.beginPath();
            for (let i = 0; i < segmentation.length; i += 2) {
                const x = (segmentation[i] / cocoData.images[0].width) * canvas.width;
                const y = (segmentation[i + 1] / cocoData.images[0].height) * canvas.height;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.closePath();

            // 高亮检测
            if (ctx.isPointInPath(mouseX, mouseY)) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                activeAnnotation = annotation;
            } else {
                ctx.fillStyle = 'rgba(255, 0, 0, 0)';
            }
            ctx.fill();
        });

        // 显示注释信息
        if (activeAnnotation) {
            const infoBoxX = event.pageX + 10;
            const infoBoxY = event.pageY + 10;
            infoBox.style.left = `${infoBoxX}px`;
            infoBox.style.top = `${infoBoxY}px`;
            infoBox.textContent = activeAnnotation.description;
            infoBox.style.display = 'block';
        } else {
            infoBox.style.display = 'none';
        }
    });
};
